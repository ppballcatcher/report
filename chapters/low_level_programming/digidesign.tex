%!TEX root = ../../report.tex
\chapter{Digital design}
\label{cha:digidesign}

To accurately measure when each piezoelectric sensor has an impact, %spelling??
a timing module is implemented in VHDL.
The timing module takes each piezoelectric sensor as an input and measures the time between each sensor registers the ball impact.
This time information may then be used to solve for the $(x,y)$ position of the impact point of the ball.

Because solving the resulting system of equations in hardware directly is deemed rather hard, %reference?
 a MicroBlaze soft core is made part of the hardware design for the FPGA.

 Full RTL and technology diagrams generated by the Xilinx tools may be found in Appendix \ref{chap:digi-diagrams}.

\section{Timing module}
\label{sec:timing_module}
The timing module has a separate input for each of the four piezoelectric elements.
Each input is attached to an SR latch synchronised with the FPGA 50\si{MHz} clock so that input signals are sampled every 20\si{ns}.

\begin{figure}[htb]
    \centering
    \input{figures/timing-module}
    \caption{Timing module logic diagram.}
    \label{fig:timing}
\end{figure}

The timing module continuously counts the number 50\si{MHz} clock cycles elapsed.
When an input signal is detected, the SR latch is set and the number of clock cycles elapsed at that time is saved to a register.
Time is saved to a different register once per piezoelectric sensor input edge.

When all four SR latches have been triggered, the timing module calculates the time difference between the input that was triggered first and the remaining three.
The output is thus four 32-bit values, where at least one is always zero -- namely the first one triggered.
The line \custtt{timings\_ready} is pulled high when all four inputs have been triggered and corresponding time values recorded.
The \custtt{timings\_ready} signal is attached to an external interrupt on the MicroBlaze microprocessor.

After one read-cycle of four triggered input signals, the timing module is in a \emph{hold}-state until it has been reset by pulling its \custtt{reset} signal high.
The microprocessor is responsible for resetting the module.

% delays introduced

\section{MicroBlaze soft microprocessor}
TODO (merge w/ Anders)

\section{Servo control?}
PWM duty to angle value?

